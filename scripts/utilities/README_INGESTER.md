# Blacksmith Atlas Metadata Ingester

This utility ingests Houdini asset metadata.json files into the Blacksmith Atlas API using the new CRUD operations.

## Overview

The Atlas Metadata Ingester processes metadata.json files generated by Houdini asset exports and creates comprehensive asset records in the Atlas database. It handles texture mapping, geometry files, node summaries, and all the rich metadata that comes from Houdini assets.

## Features

- ‚úÖ **Single File Ingestion**: Process individual metadata.json files
- ‚úÖ **Batch Processing**: Process entire directories of metadata files
- ‚úÖ **Recursive Scanning**: Recursively search for metadata files in subdirectories
- ‚úÖ **Comprehensive Mapping**: Maps all Houdini metadata to Atlas asset format
- ‚úÖ **Error Handling**: Robust error handling with detailed logging
- ‚úÖ **API Integration**: Uses the new Atlas CRUD API with full validation
- ‚úÖ **Dry Run Mode**: Validate files without creating assets
- ‚úÖ **Tag Generation**: Automatically generates tags from metadata
- ‚úÖ **File Size Estimation**: Calculates estimated file sizes for assets

## Installation & Setup

### Prerequisites

1. **Atlas API Running**: Ensure the Atlas API is running at `http://localhost:8000`
   ```bash
   # Start Atlas with Docker
   npm run docker:dev
   
   # Or start legacy mode
   npm run dev:legacy
   ```

2. **Python Dependencies**: The ingester uses standard Python libraries:
   - `requests` - for API calls
   - `json` - for metadata parsing
   - `pathlib` - for file system operations
   - `argparse` - for command line interface

3. **Make Scripts Executable**:
   ```bash
   chmod +x scripts/utilities/run_ingester.sh
   ```

## Usage

### Quick Start

```bash
# Test with example metadata file
./scripts/utilities/run_ingester.sh test

# Ingest a single metadata file
./scripts/utilities/run_ingester.sh file /path/to/metadata.json

# Ingest all metadata files in a directory
./scripts/utilities/run_ingester.sh dir /path/to/assets/directory

# Recursively ingest all metadata files
./scripts/utilities/run_ingester.sh recursive /path/to/asset/library
```

### Command Line Options

```bash
# Show help
./scripts/utilities/run_ingester.sh help

# Use different API URL
./scripts/utilities/run_ingester.sh file metadata.json --api-url http://remote-server:8000

# Enable verbose logging
./scripts/utilities/run_ingester.sh dir /path/to/assets --verbose

# Dry run (validate without creating assets)
./scripts/utilities/run_ingester.sh file metadata.json --dry-run
```

### Direct Python Usage

```bash
# Single file
python3 scripts/utilities/ingest_metadata.py /path/to/metadata.json

# Directory processing
python3 scripts/utilities/ingest_metadata.py /path/to/directory --directory

# Recursive processing
python3 scripts/utilities/ingest_metadata.py /path/to/directory --directory --recursive

# With options
python3 scripts/utilities/ingest_metadata.py metadata.json --api-url http://localhost:8000 --verbose --dry-run
```

## Metadata Transformation

The ingester transforms Houdini metadata into Atlas asset format:

### Input (Houdini metadata.json)
```json
{
  "id": "9547BE2E",
  "name": "atlas_asset", 
  "asset_type": "Assets",
  "subcategory": "Blacksmith Asset",
  "render_engine": "Redshift",
  "tags": ["assets", "blacksmith_asset", "redshift"],
  "textures": {
    "count": 13,
    "files": ["Textures/Test/catalog.jpg", "..."]
  },
  "geometry_files": {
    "count": 10,
    "files": ["Geometry/OBJ/male_1_v1_LOD1.obj", "..."]
  },
  "houdini_version": "20.5.445",
  "export_metadata": { "..." },
  "node_summary": { "..." }
}
```

### Output (Atlas Asset)
```json
{
  "name": "atlas_asset",
  "category": "Blacksmith Asset", 
  "paths": {
    "metadata_file": "/path/to/metadata.json",
    "folder_path": "/net/library/atlaslib/3D/Assets/...",
    "template_file": "template.hipnc",
    "textures": ["Textures/Test/catalog.jpg", "..."],
    "geometry": ["Geometry/OBJ/male_1_v1_LOD1.obj", "..."]
  },
  "metadata": {
    "asset_id": "9547BE2E",
    "asset_type": "Assets",
    "render_engine": "Redshift", 
    "houdini_version": "20.5.445",
    "textures": { "count": 13, "files": ["..."] },
    "geometry_files": { "count": 10, "files": ["..."] },
    "export_metadata": { "..." },
    "node_summary": { "..." },
    "hierarchy": { "..." },
    "ingested_at": "2025-08-19T15:30:00",
    "ingested_by": "metadata_ingester"
  },
  "file_sizes": {
    "template_size": 397796,
    "texture_count": 13,
    "geometry_count": 10,
    "estimated_total_size": 26974196
  },
  "tags": [
    "assets", "blacksmith_asset", "redshift", "3d", 
    "has_textures", "has_geometry", "houdini", "houdini_20"
  ]
}
```

## Generated Tags

The ingester automatically generates tags from metadata:

- **Basic Tags**: From `tags` and `search_keywords` fields
- **Render Engine**: e.g., `redshift`, `karma`, `arnold`
- **Asset Type**: e.g., `assets`, `materials`, `fx`
- **Dimension**: e.g., `3d`, `2d`
- **Content Tags**: `has_textures`, `has_geometry`
- **Software Tags**: `houdini`, `houdini_20` (major version)
- **Custom Keywords**: From search_keywords array

## File Size Estimation

The ingester estimates file sizes:

- **Template Size**: Exact size from metadata
- **Texture Estimation**: ~2MB per texture average
- **Total Estimation**: Template + estimated texture size
- **Counts**: Actual texture and geometry file counts

## Error Handling

The ingester handles various error conditions:

- **Missing Files**: Logs error and skips
- **Invalid JSON**: Logs parse error and skips  
- **API Errors**: Logs HTTP errors with details
- **Missing Required Fields**: Validates required asset fields
- **Network Issues**: Retries and logs connection problems
- **Duplicate Assets**: Detects existing assets and skips

## Logging

Comprehensive logging with different levels:

```bash
# Standard logging
INFO - ‚úÖ Connected to Atlas API v2.0
INFO - üìÑ Processing metadata file: /path/to/metadata.json  
INFO - ‚úÖ Created asset: atlas_asset (ID: asset_abc123)
INFO - üéâ Successfully ingested asset: atlas_asset

# Error logging  
ERROR - ‚ùå Failed to connect to Atlas API: Connection refused
ERROR - ‚ùå Invalid JSON in metadata.json: Expecting ',' delimiter
WARNING - ‚ö†Ô∏è Asset already exists: atlas_asset

# Verbose logging (--verbose flag)
DEBUG - üìä Transformed metadata: {"name": "atlas_asset", ...}
DEBUG - üîç API Request: POST /api/v1/assets
DEBUG - üìà File size calculation: 397796 + 26576400 = 26974196
```

## API Integration

The ingester uses the new Atlas CRUD API:

- **Endpoint**: `POST /api/v1/assets`
- **Authentication**: None required (for now)
- **Validation**: Full Pydantic model validation
- **Error Responses**: Standardized error format
- **Rate Limiting**: Respects API rate limits
- **Health Checks**: Validates API availability

## Example Workflows

### 1. Single Asset Testing
```bash
# Test with the example file
./scripts/utilities/run_ingester.sh test

# Check the result in Atlas web interface
# Visit: http://localhost:3011
```

### 2. Studio Asset Library Migration
```bash  
# Dry run first to validate
./scripts/utilities/run_ingester.sh recursive /net/library/atlaslib --dry-run --verbose

# Run the actual migration
./scripts/utilities/run_ingester.sh recursive /net/library/atlaslib --verbose

# Monitor progress and check for errors
tail -f logs/ingester.log
```

### 3. Development Asset Import
```bash
# Import assets from current project
./scripts/utilities/run_ingester.sh dir ./assets/houdini_exports --verbose

# Check specific asset
curl http://localhost:8000/api/v1/assets?search=atlas_asset
```

## Troubleshooting

### Common Issues

1. **API Not Running**
   ```
   ‚ùå Atlas API is not accessible at http://localhost:8000
   üí° Make sure the API is running with: npm run docker:dev
   ```

2. **Invalid Metadata**
   ```
   ‚ùå Invalid JSON in metadata.json: Expecting ',' delimiter
   ```
   - Check JSON syntax
   - Validate with `jq .` command

3. **Missing Required Fields**
   ```
   ‚ùå Missing required 'name' field in metadata.json
   ```
   - Ensure metadata has required fields
   - Check example metadata.json for reference

4. **Duplicate Assets**
   ```
   ‚ö†Ô∏è Asset already exists: atlas_asset
   ```
   - Asset names must be unique
   - Use API to update existing assets instead

### Debug Mode

```bash
# Enable verbose logging
./scripts/utilities/run_ingester.sh file metadata.json --verbose

# Check API health
curl http://localhost:8000/health

# View created assets
curl http://localhost:8000/api/v1/assets | jq .

# Check specific asset
curl "http://localhost:8000/api/v1/assets?search=atlas_asset" | jq .
```

## Performance

- **Single File**: ~1-2 seconds per file
- **Batch Processing**: ~50-100 assets per minute
- **Network**: Depends on API response time
- **Memory**: Minimal - processes one file at a time
- **Concurrent**: Not implemented (would require rate limit handling)

## Future Enhancements

- [ ] **Concurrent Processing**: Process multiple files in parallel
- [ ] **Resume Capability**: Skip already processed files
- [ ] **Asset Updates**: Update existing assets instead of skipping
- [ ] **Validation Reports**: Generate detailed validation reports
- [ ] **Custom Transformers**: Pluggable metadata transformation
- [ ] **Progress Bars**: Visual progress indication
- [ ] **Configuration Files**: YAML/JSON configuration support
- [ ] **Asset Relationships**: Create asset dependencies/relationships

## Contributing

To extend the ingester:

1. **Custom Transformations**: Modify `transform_metadata_to_asset()` method
2. **Additional Tags**: Update `_extract_tags()` method  
3. **File Size Calculations**: Enhance `_calculate_file_sizes()` method
4. **Error Handling**: Add error cases in exception handlers
5. **API Integration**: Extend API calls for new endpoints

## License

Part of the Blacksmith Atlas project.